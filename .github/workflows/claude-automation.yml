name: Claude Automation

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for Claude to perform'
        required: true
        default: 'Enhance the codebase'

jobs:
  claude-task:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.body, 'claude') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Log System Status
      id: system-status
      run: |
        echo "::group::System Status Check"
        echo "Current Date and Time (UTC - YYYY-MM-DD HH:MM:SS formatted): $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "Current User's Login: ${{ github.actor }}"
        echo "::endgroup::"
        echo "status=success" >> $GITHUB_OUTPUT
    
    - name: Verify Status
      if: steps.system-status.outputs.status == 'success'
      run: |
        echo "System status check passed"
        echo "Done!"

    - name: Install Dependencies
      if: steps.system-status.outputs.status == 'success'
      run: |
        echo "::group::Installing Dependencies"
        pip install anthropic requests
        echo "::endgroup::"
    
    - name: Run Claude Enhancement
      if: steps.system-status.outputs.status == 'success'
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python -c "
        import os
        import sys
        import requests
        from anthropic import Anthropic
        from datetime import datetime

        try:
            # Log start time
            print(f'Starting Claude automation at {datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")} UTC')
            
            # Verify API key
            if not os.environ.get('ANTHROPIC_API_KEY'):
                raise ValueError('ANTHROPIC_API_KEY environment variable is not set')

            client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
            
            task = '''
            Enhance the Serendipity AI project:
            1. Update main.py with session management and better error handling
            2. Create modern responsive frontend in static/index.html  
            3. Update requirements.txt with proper dependencies
            4. Make it production-ready
            '''
            
            print('Sending request to Claude...')
            response = client.messages.create(
                model='claude-3-sonnet-20240229',
                max_tokens=4000,
                messages=[{
                    'role': 'user', 
                    'content': f'Please provide enhanced code for: {task}'
                }]
            )
            
            if not response or not response.content:
                raise ValueError('No response received from Claude')

            print('Claude response received successfully!')
            print(response.content[0].text[:500])
            
            print(f'\nTask completed at {datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")} UTC')
            print('Done!')
            sys.exit(0)

        except Exception as e:
            print(f'Error occurred: {str(e)}')
            sys.exit(1)
        "
    
    - name: Final Status Check
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "Workflow completed successfully! ✅"
        else
          echo "Workflow encountered issues! ❌"
          exit 1
        fi
